<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script src="./dist/index.min.js"></script>
    <script src="https://unpkg.com/platform@1.3.6/platform.js"></script>
    <script src="https://unpkg.com/lodash@4.17.21/lodash.js"></script>
    <script src="https://unpkg.com/benchmark@2.1.4/benchmark.js"></script>
  </head>
  <body>
    <script>
      (async function () {
        /** @type {import('./src/index.d.ts')['default']} */
        const { LocalDemManager } = mlcontour;

        const awsManager = new LocalDemManager(
          "https://elevation-tiles-prod.s3.amazonaws.com/terrarium/{z}/{x}/{y}.png",
          100,
          "terrarium",
          12,
          10_000
        );

        const demoManager = new LocalDemManager(
          "https://demotiles.maplibre.org/terrain-tiles/{z}/{x}/{y}.png",
          100,
          "mapbox",
          11,
          10_000
        );
        let noMoreFetch = false;

        const suite = new Benchmark.Suite();

        await demoManager.fetchContourTile(12, 1088 * 2, 717 * 2, {
          levels: [5],
          overzoom: 1,
        }).value;

        async function addAsyncBench(name, fn) {
          await fn().value;
          suite.add(name, {
            defer: true,
            fn: (deferred) => {
              demoManager.contourCache.clear();
              awsManager.contourCache.clear();
              fn().value.then(
                () => deferred.resolve(),
                (err) => {
                  throw err;
                }
              );
            },
          });
        }

        await addAsyncBench("switzerland 512px", () =>
          demoManager.fetchContourTile(12, 2176, 1435, {
            multiplier: 3.28084,
            levels: [50],
          })
        );

        await addAsyncBench("switzerland 512px", () =>
          demoManager.fetchContourTile(12, 2176, 1435, {
            multiplier: 3.28084,
            levels: [100],
            overzoom: 1,
          })
        );

        await addAsyncBench("switzerland 512px overzoomed hilly", () =>
          demoManager.fetchContourTile(15, 17413, 11488, {
            multiplier: 3.28084,
            levels: [10],
            overzoom: 1,
          })
        );

        await addAsyncBench("switzerland 512px overzoomed flat", () =>
          demoManager.fetchContourTile(15, 17413, 11490, {
            multiplier: 3.28084,
            levels: [10],
            overzoom: 1,
          })
        );

        await addAsyncBench("switzerland 512px very overzoomed", () =>
          demoManager.fetchContourTile(18, 17413 * (1 << 3), 11488 * (1 << 3), {
            multiplier: 3.28084,
            levels: [10],
            overzoom: 1,
          })
        );

        await addAsyncBench("everest 256px overzoomed", () =>
          awsManager.fetchContourTile(15, 24295, 13728, {
            multiplier: 3.28084,
            levels: [10],
          })
        );

        await addAsyncBench("everest 256px z12", () =>
          awsManager.fetchContourTile(
            15,
            Math.floor(24295 / (1 << 3)),
            Math.floor(13729 / (1 << 3)),
            {
              multiplier: 3.28084,
              levels: [100],
            }
          )
        );

        await addAsyncBench("everest 256px overzoomed z15", () =>
          awsManager.fetchContourTile(15, 24295, 13729, {
            multiplier: 3.28084,
            levels: [10],
          })
        );

        await addAsyncBench("everest 256px overzoomed z18", () =>
          awsManager.fetchContourTile(18, 24295 * (1 << 3), 13729 * (1 << 3), {
            multiplier: 3.28084,
            levels: [10],
          })
        );

        noMoreFetch = true;

        let total = 0;

        suite
          .on("error", (event) => console.log(event.target.error))
          .on("cycle", (event) => {
            const time = 1_000 / event.target.hz;
            total += time;
            console.log(`${time.toPrecision(4)}ms ${event.target}`);
          })
          .on("complete", () => console.log(`${total.toPrecision(4)}ms total`))
          .run();
      })();
    </script>
  </body>
</html>
